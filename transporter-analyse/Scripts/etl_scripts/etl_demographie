#Importation des librairies
import os
import pandas as pd
from sqlalchemy import create_engine

from dotenv import load_dotenv

load_dotenv()

#Mise en place de l'environnement
DB_HOST = os.getenv("DB_HOST")
DB_NAME = os.getenv("DB_NAME")
DB_USER = os.getenv("DB_USER")
DB_PASSWORD = os.getenv("DB_PASSWORD")

DATABASE_URL = f"postgresql+psycopg2://{DB_USER}:{DB_PASSWORD}@{DB_HOST}/{DB_NAME}"
input_path = 'output/demographie_datas_clean'


def process_etl_demographie():
    df_demographie = pd.read_csv(
        os.path.join(input_path, '/transf_demographie.csv') , sep = ",")

    #Préparation de la table de staging
    df_demographie = df_demographie.drop(columns = 'Code')

    stg_demographie = df_demographie.rename(columns = {'Libellé':'nom_commune','Unités légales (en nombre) 2021':'unite_legal_2021','Population municipale 2022':'pop22',"Densité de population (historique depuis 1876) 2021":'dens1876_2021',"Part construction dans les créations d'ent. 2023":'part_construction_entreprise_2023'})

    # Insertion dans PostgreSQL
    engine = create_engine(DATABASE_URL)
    stg_demographie.to_sql("stg_demographie", engine, if_exists="append", index=False)

if __name__ == "__main__":
    process_etl_demographie()